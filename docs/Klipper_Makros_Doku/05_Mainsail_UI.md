## Makros in Mainsail nutzen (UI-Integration)

**Anzeige und Ausführung:** In der Weboberfläche *Mainsail* werden alle definierten Makros automatisch in einem eigenen Bereich auf dem Dashboard angezeigt (standardmäßig alphabetisch sortiert) ([Macros | Mainsail](https://docs.mainsail.xyz/overview/settings/macros#:~:text=This%20mode%20is%20very%20simple,a%20panel%20on%20the%20dashboard)). Der Benutzer kann dort per Klick ein Makro ausführen. Mainsail bietet zwei Modi für die Makro-Anzeige: im **Simple Mode** werden alle Makros in einer Liste gezeigt (man kann nur auswählen, welche versteckt werden sollen), während im **Expert Mode** Makros in **Gruppen** organisiert werden können ([Macros | Mainsail](https://docs.mainsail.xyz/overview/settings/macros#:~:text=Expert%20Mode)) ([Macros | Mainsail](https://docs.mainsail.xyz/overview/settings/macros#:~:text=2)). So kann man z.B. eine Gruppe "Vor dem Druck" mit Makros wie Homing, Preheat etc. und eine Gruppe "Während des Drucks" mit Filamentwechsel, Pause usw. anlegen. Jede Gruppe und jedes Makro kann mit Farben und Sichtbarkeiten (abhängig vom Druckerstatus idle/printing/paused) konfiguriert werden ([Macros | Mainsail](https://docs.mainsail.xyz/overview/settings/macros#:~:text=2)) ([Macros | Mainsail](https://docs.mainsail.xyz/overview/settings/macros#:~:text=6,group%20color%20or%20independent%20color)). Diese Einstellungen nimmt man in Mainsail über das **Macro Management** vor (z.B. Makros sortieren, farblich hervorheben, oder automatisches Ausblenden mancher Makros im Druckbetrieb). Die Makros selbst bleiben jedoch im Klipper-Konfigurationsfile definiert – Mainsail schreibt diese nicht um, sondern steuert nur die Darstellung.

**Makro-Beschreibungen:** Wenn in der Makrodefinition eine `description:` angegeben ist, zeigt Mainsail diese als Tooltip oder Info an. Außerdem werden einige Standardmakros (z.B. PAUSE, RESUME) von der UI speziell behandelt: Nutzt man das `[pause_resume]`-Modul in Klipper und definiert dort Makros bzw. Verhalten für Pause/Fortsetzen, werden die entsprechenden Buttons in Mainsail (Pause/Resume) diese Makros auslösen ([Pause/Resume, Filament Swaps & Sensors - Ellis' Print Tuning Guide](https://ellis3dp.com/Print-Tuning-Guide/articles/useful_macros/pause_resume_filament.html#:~:text=Pause%2FResume%2C%20Filament%20Swaps%20%26%20Sensors,be%20able%20to%20use%20these)) ([G-Codes - Klipper documentation](https://www.klipper3d.org/G-Codes.html#:~:text=G,into%20the%20OctoPrint%20terminal%20tab)). Häufig definieren User auch Makros wie `CANCEL_PRINT` oder `FILAMENT_CHANGE`, die dann mit den UI-Buttons verknüpft werden.

**Parameter-Eingabe in Mainsail:** Hat ein Makro definierbare Parameter, erkennt Mainsail dies in vielen Fällen automatisch. Die Oberfläche generiert Eingabefelder, wenn im Makrotext Vorkommen von `params.XYZ` gefunden werden. Zum Beispiel, ein Makro mit `{ params.FEED|int }` könnte in Mainsail ein Feld für *FEED* anzeigen. Allerdings ist diese Erkennung rudimentär (basiert auf Regex-Suche) und kann fehlschlagen, insbesondere bei komplexeren Template-Konstrukten ([Hinting for Mainsail's macro parameter detection - Macros - Klipper](https://klipper.discourse.group/t/hinting-for-mainsails-macro-parameter-detection/2100#:~:text=Mainsail%20uses%20a%20regex%20to,the%20end%20of%20my%20macro)). Ein Trick aus der Community ist es, am Ende des Makros einen **Dummy-Parameterblock** als mehrzeilige Zeichenkette einzufügen, der alle möglichen Parameter einmal referenziert. Dadurch “sieht” Mainsail die Parameter und kann sie darstellen ([Hinting for Mainsail's macro parameter detection - Macros - Klipper](https://klipper.discourse.group/t/hinting-for-mainsails-macro-parameter-detection/2100#:~:text=,End%20argument%20block%20for%20Mainsail)) ([Hinting for Mainsail's macro parameter detection - Macros - Klipper](https://klipper.discourse.group/t/hinting-for-mainsails-macro-parameter-detection/2100#:~:text=The%20%E2%80%9Cparameter%20block%E2%80%9D%20is%20really,condition%20in%20the%20assignment)). Dieser Dummy-Block wird so formuliert, dass er bei der Makro-Auswertung keine Wirkung hat (z.B. in einem nie ausgeführten Zweig). Hier ein Ausschnitt nach einer Idee von *jschuh*:

```ini
  # Dummy argument block for Mainsail UI
  {% set dummy = None if True else "
  {% set d = params.LENGTH|default(100)|float %}
  {% set d = params.SPEED|default(50)|float %}
  {% set d = params.EXTRUDER|default(\"Tool0\")|string %}
  " %}
```

In diesem Konstrukt bewirkt `None if True else "..."`, dass der eigentliche Inhalt nie ausgeführt wird – er steht de facto in einem toten Zweig und beeinflusst das Makro nicht. Mainsail scannt aber Zeile für Zeile und findet darin `params.LENGTH`, `params.SPEED`, `params.EXTRUDER` usw., und wird dem Nutzer dafür Felder anbieten ([Hinting for Mainsail's macro parameter detection - Macros - Klipper](https://klipper.discourse.group/t/hinting-for-mainsails-macro-parameter-detection/2100#:~:text=%7B,End%20argument%20block%20for%20Mainsail)) ([Hinting for Mainsail's macro parameter detection - Macros - Klipper](https://klipper.discourse.group/t/hinting-for-mainsails-macro-parameter-detection/2100#:~:text=The%20%E2%80%9Cparameter%20block%E2%80%9D%20is%20really,condition%20in%20the%20assignment)). Die im `default(...)` angegebenen Werte oder Texte werden von Mainsail als Hinweistext für die Felder genutzt (z.B. als Platzhalter oder Tooltip), was zur Dokumentation der erwarteten Eingaben genutzt werden kann ([Hinting for Mainsail's macro parameter detection - Macros - Klipper](https://klipper.discourse.group/t/hinting-for-mainsails-macro-parameter-detection/2100#:~:text=You%E2%80%99ll%20want%20to%20put%20the,of%20a%20config%20parameter%2C%20etc)).

**Makro-Prompts (Dialoge):** Seit Mainsail Version 2.9.0 gibt es die Möglichkeit, über Makros interaktive **Dialogfenster** in der Weboberfläche zu erzeugen ([Macro Prompts | Mainsail](https://docs.mainsail.xyz/overview/features/macro-prompts#:~:text=This%20feature%20has%20been%20implemented,safe%20to%20use%20this%20feature)). Diese Funktion erfordert, dass in Klipper das `[respond]`-Modul aktiviert ist (in `printer.cfg` hinzufügen). Ein Makro kann dann spezielle Kommentare mit `// action:...` senden, die von Mainsail ausgewertet werden ([Macro Prompts | Mainsail](https://docs.mainsail.xyz/overview/features/macro-prompts#:~:text=This%20feature%20needs%20the%20%60,enabled%20in%20your%20Klipper%20config)). Beispiele für solche *Prompt-Kommandos* sind: 

- `// action:prompt_begin Titel` – Startet die Definition eines Dialogs mit dem gegebenen Titel.  
- `// action:prompt_text Text` – Fügt Erklärungstext im Dialog ein.  
- `// action:prompt_button Label|GCODE|Color` – Fügt einen Button hinzu. Man kann optional angeben, welcher G-Code bei Klick gesendet wird (Standard ist das Label selbst) und welche Farbe der Button hat.  
- `// action:prompt_show` – Zeigt den zusammengebauten Dialog an.  
- `// action:prompt_end` – Beendet die Dialogdefinition.

Mit dieser Reihe von Kommandos kann ein Makro den Benutzer z.B. fragen "*Druck wirklich fortsetzen?*" mit zwei Buttons "Ja (RESUME)" und "Nein (Cancel)". Der Benutzer kann dann interagieren, ohne in die Konsole tippen zu müssen. Intern arbeitet das so, dass das Makro über `action_respond_info` die speziellen Marker sendet, die Mainsail erkennt und einen modalen Dialog darstellt. Diese Funktion eröffnet neue Möglichkeiten der Benutzerinteraktion (z.B. Filamentwechsel-Dialoge mit Auswahl des neuen Filaments etc.) und entlastet von starren Abläufen ([Macro Prompts | Mainsail](https://docs.mainsail.xyz/overview/features/macro-prompts#:~:text=Macro%20Prompts)).

Zusammengefasst erleichtert Mainsail dem Nutzer die Bedienung von Makros erheblich: Makros werden sichtbar präsentiert, können per Klick gestartet werden, Parameter können in der UI eingegeben werden und mit Makro-Prompts kann die Interaktion weiter verbessert werden. Als Anwender sollte man darauf achten, Makro-Namen und Beschreibungen sprechend zu wählen und ggf. unwichtige/technische Makros (z.B. Hilfs-Makros, die von anderen Makros aufgerufen werden) in der UI auszublenden, um die Oberfläche übersichtlich zu halten.
